# merged from jumpbox.sh

(git config -l|grep -q alias.lol) || git config --global --add alias.lol "log --graph --decorate --pretty=oneline --abbrev-commit --all"
(git config -l|grep -q alias.co) || git config --global --add alias.co "checkout"
(git config -l|grep -q alias.st) || git config --global --add alias.st "status"
(git config -l|grep -q alias.ci) || git config --global --add alias.ci "duet-commit"

export EDITOR=vim
export TMPDIR=$HOME/tmp
for path_element in $HOME/go/bin $HOME/bin /usr/local/bin ; do
    PATH+=":${path_element}"
done

# Typos
alias bundel='bundle '
alias gti='git '
alias le='less '
alias les='less '

# Useful commands
alias ll='ls -alrt'

function bosh_me() {
  if [[ "$#" -ne 1  || ! "$1" =~ prod|staging|lakitu|birdnest ]]; then
    echo 'Usage: bosh_me [prod|staging|lakitu|birdnest]'
    return 1
  fi
  BOSH_ENV=$1

  director_host=bosh.${BOSH_ENV}.cf-app.com
  deployment=$HOME/workspace/deployments-aws/$BOSH_ENV/cf-aws-stub.yml
  if [ $BOSH_ENV = "prod" ]; then
    director_host=bosh.run.pivotal.io
    deployment=${HOME}/workspace/prod-aws/deployments/cf-cfapps-io2.yml
  elif [ $BOSH_ENV = "staging" ]; then
    deployment=${HOME}/workspace/staging-aws/deployments/cf-staging.yml
  elif [ $BOSH_ENV = "lakitu" ]; then
    deployment=${HOME}/workspace/lakitu-aws/deployments/cf-lakitu-ci.yml
  elif [ $BOSH_ENV = "birdnest" ]; then
    deployment=${HOME}/workspace/birdnest-aws/deployments/cf-birdnest.yml
  fi

  bosh target $director_host
  bosh deployment $deployment
  bosh status
}

function router_status() {
  if [[ "$#" -ne 1  || ! "$1" =~ prod|staging|lakitu ]]; then
    echo 'Usage: router_status [prod|staging|lakitu]'
    return 1
  fi
  BOSH_ENV=$1
  if [ $BOSH_ENV = "prod" ]; then
    deployment=${HOME}/workspace/prod-aws/deployments/cf-cfapps-io2.yml
  elif [ $BOSH_ENV = "staging" ]; then
    deployment=${HOME}/workspace/staging-aws/deployments/cf-staging.yml
  elif [ $BOSH_ENV = "lakitu" ]; then
    deployment=${HOME}/workspace/cloudops-ci/lakitu/deployments/cf-lakitu-ci.yml
  fi
  GREP_USER="data = YAML::load(STDIN.read); puts data['properties']['router']['status']['user']"
  GREP_PASS="data = YAML::load(STDIN.read); puts data['properties']['router']['status']['password']"
  user=`cat $deployment | ruby -ryaml -e "$GREP_USER"`
  pass=`cat $deployment | ruby -ryaml -e "$GREP_PASS"`

  for i in varz routes ; do
    bosh vms |grep router | cut -f 5 -d '|' | tr -d ' ' | parallel -j 20 -rt --keep "curl -s http://$user:$pass@{}:8080/$i | jq .> ~/tmp/{}.$i.json" ;
  done
}

function repo_all_the_way() {
  ORGREPO="$1"
  REPO="$(basename "${ORGREPO}")"
  pushd "$HOME/workspace/${REPO}"
  if [[ -x update ]]; then
    ./update
  else
    git submodule update --init --recursive
  fi

  popd
}
export -f repo_all_the_way

function all_the_repos() {
  ssh -o StrictHostKeyChecking=false -T git@github.com
  mkdir -p ~/workspace
  pushd ~/workspace
  local_dir=$(pwd)
  unset GET_ME

  for i in \
           cloudfoundry-incubator/diego-release \
           pivotal-cloudops/birdnest-aws \
           cloudfoundry/cf-release \
           pivotal-cf-experimental/basic-env \
           pivotal-cf/deployments-aws \
           pivotal-cf/prod-keys \
           pivotal-cloudops/cloudops-ci \
           pivotal-cloudops/prod-aws \
           pivotal-cloudops/mysql_restore \
           pivotal-cloudops/staging-aws \
           pivotal-cloudops/lakitu-aws \
           pre-commit/pre-commit-hooks
  do
    [[ -d ${i#*/} ]] || GET_ME+="$i "
  done
  echo $GET_ME
  git clone git@github.com:pivotal-cloudops/cloudops-tools

  [[ ! -z $GET_ME ]] && parallel -j 25 -rt --keep  git clone --template=$local_dir/cloudops-tools/git_templates "git@github.com:{}" ::: $GET_ME

  popd
  unset GET_ME
}

function work_on() {
APP_NAME=$1
APP_PATH=~/workspace/$APP_NAME

if [ -d ~/workspace/$APP_NAME ] ; then
  cd $APP_PATH
  git diff-index --quiet HEAD --  || echo "You have unfinished work in ${APP_NAME}." 
else
  git clone git@github.com:pivotal-cloudops/${APP_NAME}.git ${APP_PATH} 2>/dev/null || 
  git clone git@github.com:pivotal-cf/${APP_NAME}.git ${APP_PATH} 2>/dev/null|| 
  git clone git@github.com:pivotal-cf-experimental/${APP_NAME}.git ${APP_PATH} 2>/dev/null|| 
  git clone git@github.com:cloudfoundry/${APP_NAME}.git ${APP_PATH} 2>/dev/null||
  git clone git@github.com:cloudfoundry-incubator/${APP_NAME}.git ${APP_PATH} 2>/dev/null ||
  {
    echo "Repository doesn't exist in any pivotal / cloudfoundry repositories" && return 1
  }

  repo_all_the_way $APP_NAME
fi
  cd $APP_PATH
  git status
}

function cf_login
{
  msg="Please set an environment <staging|prod>"
  environment=$1
  if [ -z $1 ];
  then echo $msg
   fi
  if [ $environment == 'staging' ]; then
    api="https://api.staging.cf-app.com"
  elif [ $environment == "prod" ]; then
    api="https://api.run.pivotal.io"
  else
    echo $msg 
    return 1
  fi

  username='admin'
  password=`grep -- "- admin" ~/workspace/${environment}-aws/deployments/cf.yml | cut -d\| -f2`
  cf api ${api}
  cf auth ${username} ${password}
  cf target -o "cloudops" -s "cloudops"

}

function bosh() {
  if [ "$1" = ssh ]; then 
    shift; 
    set ssh --strict_host_key_checking no "$@"; 
  fi; 
  command bosh "$@" ;
}
